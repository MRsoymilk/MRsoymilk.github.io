

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>使用minzi解压zip [ Soymilk ]</title>
  
<link rel="shortcut icon" href="/favicon/favicon.ico">

<link rel="stylesheet" href="/lib/fancybox/jquery.fancybox.min.css">



<link rel="stylesheet" href="/lib/fontawesome/css/all.min.css">



<link rel="stylesheet" id="highlight-link" href="/lib/highlight/style/railscasts.css">



<link rel="stylesheet" href="/css/milk.css">


<link rel="stylesheet" id="shceme-link" href="/css/theme/default.css">


<meta name="generator" content="Hexo 7.3.0"></head>
<body>
  <div class="milk">
    <div class="milk-header">
       

  <nav class="header-nav">
     
    <div class="nav-menu">
      
        <div id="Home" class="menu-item">
          <i class="fas fa-home" aria-hidden="true"></i>
          <a href="/ ">Home</a>
        </div>
      
        <div id="Archives" class="menu-item">
          <i class="fas fa-archive" aria-hidden="true"></i>
          <a href="/archives ">Archives</a>
        </div>
      
        <div id="About" class="menu-item">
          <i class="fas fa-user-circle" aria-hidden="true"></i>
          <a href="/about ">About</a>
        </div>
      
    </div>
    
    
      <div class="nav-date">
        <div id="date-ymd"></div>
        <div id="date-week"></div>
        <div id="date-time"></div>
      </div>
    
    
    
      <div class="nav-system" id="nav-system"></div>
    
    
    <div class="nav-layout" id="nav-layout" data-layout="tile">
      <div id="layout-show">
        <div class="show-icon"></div>
        <div class="show-text"></div>
      </div>
    </div>
    
    <div class="nav-access">
      <i class="fas fa-toggle-off" id="nav-access"></i>
      <div class="dropdown-content" id="dropdown-content">
        <ul class="social">
          
            <li>
              <a target="_blank" rel="noopener" href="https://github.com/MRsoymilk">
                <i class="fab fa-github-alt" aria-hidden="true"></i>
              </a>
            </li>
          
            <li>
              <a href="mailto:codermrsoymilk@gmail.com">
                <i class="fas fa-envelope" aria-hidden="true"></i>
              </a>
            </li>
          
        </ul>
        <ul>
          <li><span>Powered by <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a></span></li>
        </ul>
        <div>
          <label for="scheme-select">Color scheme: </label>
          <select id="scheme-select">
            <option value='default'>default</option>
          </select>
          <label for="highlight-select">Code highlight: </label>
          <select id="highlight-select">
            <option value='railscasts'>railscasts</option>
          </select>
        </div>
        <div>
          <label for="ffolders-select">ffolders scheme: </label>
          <select name="size" id="size-select">
            <option value='medium'>medium</option>
          </select>
          <select name="color" id="color-select">
            <option value='pink'>pink</option>
          </select>
        </div>
        <div>
          <label for="blur-slider">background blur
            <span id="blur-value">10</span> px
          </label>
          <input type="range" id="blur-slider" min="0" max="20" data-value='10'>
        </div>
        <div>
          <label for="font-enable">font</label>
          <input type="checkbox" id="font-check" name="font-check" data-check="fun.ttf">
        </div>
      </div>
    </div>
  </nav>
 
    </div>
    <div class="milk-body">
      
<div class="draggable-toc">
  <div class="toc-title">使用minzi解压zip</div>
  <p>process: <span>0</span></p>
  <div class="progress-container">
    <div class="progress-bar" id="bar"></div>
  </div>
  <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-text">简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E7%A7%8D%E5%9C%A8-Windows-%E4%B8%8B%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-text">一种在 Windows 下的实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#miniz-%E9%85%8D%E7%BD%AE"><span class="toc-text">miniz 配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%B4%E6%96%87%E4%BB%B6"><span class="toc-text">头文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#h-%E5%AE%9E%E7%8E%B0"><span class="toc-text">.h 实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E7%A7%8D-Linux-%E4%B8%8B%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-text">一种 Linux 下的实现</span></a></li></ol>
</div>

<div class="post-content" id="post-content">
  <div id="top">使用minzi解压zip</div>
  <div class="post">
    
    <div class="content-categories">
      
      <i class="fas fa-location-arrow"></i>
      <ul>
        <li>categories</li>
        
          <li>&gt;</li>
          <li>
            <a href="/categories/Code/">
          Code
        </a>
          </li>
      
          <li>&gt;</li>
          <li>
            <a href="/categories/Code/CPP/">
          CPP
        </a>
          </li>
      
      </ul>
    
    </div>
    <hr>
    
    <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p><img src="https://github.com/richgel999/miniz" alt="miniz">，一个轻量的 zlib (RFC 1950) and Deflate (RFC 1951) 实现库。</p>
<span id="more"></span>

<h2 id="一种在-Windows-下的实现"><a href="#一种在-Windows-下的实现" class="headerlink" title="一种在 Windows 下的实现"></a>一种在 Windows 下的实现</h2><h3 id="miniz-配置"><a href="#miniz-配置" class="headerlink" title="miniz 配置"></a>miniz 配置</h3><ol>
<li><img src="/include_miniz.jpg" alt="加入include目录"></li>
<li><img src="/add_miniz.jpg" alt="项目添加对应文件"></li>
</ol>
<h3 id="头文件"><a href="#头文件" class="headerlink" title="头文件"></a>头文件</h3><pre><code class="cpp">#pragma once

#include &lt;memory&gt;

class MY_Zip &#123;
public:
    MY_Zip();
    virtual ~MY_Zip();
    bool unzip(const char* in, const char* out);
    const char* error();
    int code();
private:
    class Impl;
    std::unique_ptr&lt;Impl&gt; m_pImpl;
&#125;;
</code></pre>
<h3 id="h-实现"><a href="#h-实现" class="headerlink" title=".h 实现"></a>.h 实现</h3><pre><code class="cpp">#include &quot;MY_Zip.h&quot;
#include &quot;miniz.h&quot;
#include &lt;iostream&gt;
#include &lt;string&gt;
#include &lt;vector&gt;
#include &lt;windows.h&gt;
#include &lt;memory&gt;
#include &lt;ShlObj_core.h&gt;


class MY_Zip::Impl &#123;
public:
  std::string errMsg;
  int errCode;
  bool IsDirectory(const std::string&amp; path) &#123;
    std::string name = path;
    return !name.empty() &amp;&amp; (name.back() == &#39;/&#39; || name.back() == &#39;\\&#39;);
  &#125;

  bool CreateDirectory(const std::string&amp; path) &#123;
    int result = SHCreateDirectoryExW(NULL, string2wstring(path).c_str(), NULL);
    return result == ERROR_SUCCESS || result == ERROR_ALREADY_EXISTS;
  &#125;
private:
  std::string wstring2string(const std::wstring&amp; wstr) &#123;
    int size_needed = WideCharToMultiByte(CP_UTF8, 0, wstr.c_str(), -1, NULL, 0, NULL, NULL);
    std::string str(size_needed - 1, 0);
    WideCharToMultiByte(CP_UTF8, 0, wstr.c_str(), -1, &amp;str[0], size_needed, NULL, NULL);
    return str;
  &#125;

  std::wstring string2wstring(const std::string&amp; str) &#123;
    int size_needed = MultiByteToWideChar(CP_UTF8, 0, str.c_str(), -1, NULL, 0);
    std::wstring wstr(size_needed - 1, 0);
    MultiByteToWideChar(CP_UTF8, 0, str.c_str(), -1, &amp;wstr[0], size_needed);
    return wstr;
  &#125;
&#125;;

MY_Zip::MY_Zip() : m_pImpl(new Impl)
&#123;
&#125;

MY_Zip::~MY_Zip()
&#123;
&#125;

bool MY_Zip::unzip(const char* in, const char* out)
&#123;
  mz_zip_archive archive&#123;&#125;;
  if (!mz_zip_reader_init_file(&amp;archive, in, 0)) &#123;
    m_pImpl-&gt;errMsg = &quot;can not open zip file: &quot; + std::string(in);
    std::cerr &lt;&lt; m_pImpl-&gt;errMsg &lt;&lt; std::endl;
    return false;
  &#125;
  int file_cnt = (int)mz_zip_reader_get_num_files(&amp;archive);
  if (file_cnt == 0) &#123;
    m_pImpl-&gt;errMsg = &quot;zip file is empty&quot;;
    std::cerr &lt;&lt; m_pImpl-&gt;errMsg &lt;&lt; std::endl;
    return false;
  &#125;

  for (int i = 0; i &lt; file_cnt; ++i) &#123;
    mz_zip_archive_file_stat file_stat;
    if (!mz_zip_reader_file_stat(&amp;archive, i, &amp;file_stat)) &#123;
      m_pImpl-&gt;errMsg = &quot;can&#39;t get file infomation in zip&quot;;
      mz_zip_reader_end(&amp;archive);
      return false;
    &#125;

    std::string path = std::string(out) + &quot;\\&quot; + file_stat.m_filename;
    if (m_pImpl-&gt;IsDirectory(path)) &#123;
      m_pImpl-&gt;CreateDirectory(path);
      continue;
    &#125;

    size_t last_slash = path.find_last_of(&quot;/\\&quot;);
    if (last_slash != std::string::npos) &#123;
      m_pImpl-&gt;CreateDirectory(path.substr(0, last_slash));
    &#125;

    if (!mz_zip_reader_extract_to_file(&amp;archive, i, path.c_str(), 0)) &#123;
      m_pImpl-&gt;errMsg = &quot;unzip failed &quot; + path;
      m_pImpl-&gt;errCode = archive.m_last_error;
      std::cerr &lt;&lt; m_pImpl-&gt;errMsg &lt;&lt; std::endl;
      mz_zip_reader_end(&amp;archive);
      return false;
    &#125;
  &#125;
  mz_zip_reader_end(&amp;archive);
  m_pImpl-&gt;errMsg = &quot;&quot;;
  std::cout &lt;&lt; &quot;unzip complete.&quot; &lt;&lt; std::endl;
  return true;
&#125;

const char* MY_Zip::error()
&#123;
  return m_pImpl-&gt;errMsg.c_str();
&#125;

int MY_Zip::code()
&#123;
  return m_pImpl-&gt;errCode;
&#125;
</code></pre>
<p>使用:</p>
<pre><code class="cpp">string tempLatestFile = ANSItoUTF8(strLatestFile.GetBuffer());
string tempLatestFolder = ANSItoUTF8(strLatestFolder.GetBuffer());
hjZip.unzip(tempLatestFile.c_str(), tempLatestFolder.c_str())
</code></pre>
<p><img src="/miniz_unzip.jpg" alt="miniz_unzip"></p>
<p>其中路径转换：</p>
<pre><code class="cpp">string UTF8toANSI(const std::string&amp; instr) //utf-8--&gt;ansi
&#123;
    int MAX_STRSIZE = instr.length() * 2 + 2;
    WCHAR* wcharstr = new WCHAR[MAX_STRSIZE];
    memset(wcharstr, 0, MAX_STRSIZE);
    MultiByteToWideChar(CP_UTF8, 0, (char*)instr.data(), -1, wcharstr, MAX_STRSIZE);
    char* charstr = new char[MAX_STRSIZE];
    memset(charstr, 0, MAX_STRSIZE);
    WideCharToMultiByte(CP_ACP, 0, wcharstr, -1, charstr, MAX_STRSIZE, NULL, NULL);
    string charstrtemp(charstr);
    delete []wcharstr;
    delete []charstr;
    return charstrtemp;
&#125;

string ANSItoUTF8(const std::string&amp; instr) //ansi--&gt;utf-8
&#123;
    int MAX_STRSIZE = instr.length() * 2 + 2;
    WCHAR* wcharstr = new WCHAR[MAX_STRSIZE];
    memset(wcharstr, 0, MAX_STRSIZE);
    MultiByteToWideChar(CP_ACP, 0, (char*)instr.data(), -1, wcharstr, MAX_STRSIZE);
    char* charstr = new char[MAX_STRSIZE];
    memset(charstr, 0, MAX_STRSIZE);
    WideCharToMultiByte(CP_UTF8, 0, wcharstr, -1, charstr, MAX_STRSIZE, NULL, NULL);
    CString charstrtemp(charstr);
    delete[] wcharstr;
    delete[] charstr;
    return (LPCSTR)charstrtemp;
&#125;
</code></pre>
<h2 id="一种-Linux-下的实现"><a href="#一种-Linux-下的实现" class="headerlink" title="一种 Linux 下的实现"></a>一种 Linux 下的实现</h2><p>使用 C++17 的 filesystem</p>
<p>CMakeLists.txt 配置（使用 <code>git clone</code> 获取对应的 miniz 项目）：</p>
<pre><code class="cmake">cmake_minimum_required(VERSION 3.10)
project(test)

set(CMAKE_CXX_STANDARD 17)

add_subdirectory(vendor/miniz)

add_executable(test main.cpp MY_Zip.h MY_Zip.cpp)

target_link_libraries(test miniz)
</code></pre>
<p>代码部分改动实现即可：</p>
<pre><code class="cpp">#include &quot;MY_Zip.h&quot;
#include &quot;miniz.h&quot;
#include &lt;iostream&gt;
#include &lt;string&gt;
#include &lt;memory&gt;
#include &lt;filesystem&gt;

namespace fs = std::filesystem;

class MY_Zip::Impl &#123;
public:
  std::string errMsg;
  int errCode;

  bool IsDirectory(const std::string&amp; path) &#123;
    return !path.empty() &amp;&amp; (path.back() == &#39;/&#39; || path.back() == &#39;\\&#39;);
  &#125;

  bool CreateDirectory(const std::string&amp; path) &#123;
    std::error_code ec;
    return fs::create_directories(fs::path(path), ec) || ec.value() == 0;
  &#125;
&#125;;

MY_Zip::MY_Zip() : m_pImpl(new Impl) &#123;&#125;
MY_Zip::~MY_Zip() &#123;&#125;

bool MY_Zip::unzip(const char* in, const char* out) &#123;
  mz_zip_archive archive&#123;&#125;;
  if (!mz_zip_reader_init_file(&amp;archive, in, 0)) &#123;
    m_pImpl-&gt;errMsg = &quot;can not open zip file: &quot; + std::string(in);
    std::cerr &lt;&lt; m_pImpl-&gt;errMsg &lt;&lt; std::endl;
    return false;
  &#125;

  int file_cnt = static_cast&lt;int&gt;(mz_zip_reader_get_num_files(&amp;archive));
  if (file_cnt == 0) &#123;
    m_pImpl-&gt;errMsg = &quot;zip file is empty&quot;;
    std::cerr &lt;&lt; m_pImpl-&gt;errMsg &lt;&lt; std::endl;
    mz_zip_reader_end(&amp;archive);
    return false;
  &#125;

  for (int i = 0; i &lt; file_cnt; ++i) &#123;
    mz_zip_archive_file_stat file_stat;
    if (!mz_zip_reader_file_stat(&amp;archive, i, &amp;file_stat)) &#123;
      m_pImpl-&gt;errMsg = &quot;can&#39;t get file info in zip&quot;;
      mz_zip_reader_end(&amp;archive);
      return false;
    &#125;

    fs::path targetPath = fs::path(out) / file_stat.m_filename;

    if (m_pImpl-&gt;IsDirectory(file_stat.m_filename)) &#123;
      m_pImpl-&gt;CreateDirectory(targetPath.string());
      continue;
    &#125;

    fs::path parentDir = targetPath.parent_path();
    m_pImpl-&gt;CreateDirectory(parentDir.string());

    if (!mz_zip_reader_extract_to_file(&amp;archive, i, targetPath.string().c_str(), 0)) &#123;
      m_pImpl-&gt;errMsg = &quot;unzip failed: &quot; + targetPath.string();
      m_pImpl-&gt;errCode = archive.m_last_error;
      std::cerr &lt;&lt; m_pImpl-&gt;errMsg &lt;&lt; std::endl;
      mz_zip_reader_end(&amp;archive);
      return false;
    &#125;
  &#125;

  mz_zip_reader_end(&amp;archive);
  m_pImpl-&gt;errMsg = &quot;&quot;;
  std::cout &lt;&lt; &quot;unzip complete.&quot; &lt;&lt; std::endl;
  return true;
&#125;

const char* MY_Zip::error() &#123;
  return m_pImpl-&gt;errMsg.c_str();
&#125;

int MY_Zip::code() &#123;
  return m_pImpl-&gt;errCode;
&#125;
</code></pre>
<p><img src="/test_on_linux.jpg" alt="test_on_linux"></p>

    
    <hr>
    <div class="content-tags">
      
      <i class="fas fa-tags"></i>
      <ul>
        
        <li><a href="/tags/CPP/">
          CPP
        </a></li>
      
      </ul>
    
    </div>
    
     
<div class="comment-tabs" id="comment-tabs">
  comment:
  <ul>
    
      <li><a href="#Valine">Valine</a></li>
    
    
      <li><a href="#LiveRe">LiveRe</a></li>
    
    
      <li><a href="#ChangYan">ChangYan</a></li>
    
  </ul>
  
  
    <div id="ChangYan">
      <!--PC和WAP自适应版-->
      <div id="SOHUCS" ></div> 
      <script type="text/javascript"> 
      (function(){ 
      var appid = 'cyuGH4lBk'; 
      var conf = 'ae32d85e4ca99348209aedfd3ae01478'; 
      var width = window.innerWidth || document.documentElement.clientWidth; 
      if (width < 960) {
      var head = document.getElementsByTagName('head')[0]||document.head||document.documentElement;
      var script = document.createElement('script');
      script.type = 'text/javascript';
      script.charset = 'utf-8';
      script.id = 'changyan_mobile_js';
      script.src = 'https://cy-cdn.kuaizhan.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&conf=' + conf;
      head.appendChild(script);
      } else { var loadJs=function(d,a){var c=document.getElementsByTagName("head")[0]||document.head||document.documentElement;var b=document.createElement("script");b.setAttribute("type","text/javascript");b.setAttribute("charset","UTF-8");b.setAttribute("src",d);if(typeof a==="function"){if(window.attachEvent){b.onreadystatechange=function(){var e=b.readyState;if(e==="loaded"||e==="complete"){b.onreadystatechange=null;a()}}}else{b.onload=a}}c.appendChild(b)};loadJs("https://cy-cdn.kuaizhan.com/upload/changyan.js",function(){window.changyan.api.config({appid:appid,conf:conf})}); } })(); 
      </script>
    </div>
   
  
  
    <div id="LiveRe">
      
        <!-- LiveRe City install code -->
        <div id="lv-container" data-id="city" data-uid="MTAyMC80NjA4MS8yMjU5Mg==">
          <script type="text/javascript">
            (function(d, s) {
              var j, e = d.getElementsByTagName(s)[0];
              if (typeof LivereTower === 'function') { return; }
              j = d.createElement(s);
              j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
              j.async = true;
              e.parentNode.insertBefore(j, e);
            })(document, 'script');
          </script>
          <noscript>Please activate JavaScript for write a comment in LiveRe</noscript>
          </div>
          <!-- completed City install code -->
        
    </div>
  
  
  
    <div id="Valine">
      <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
      <div id="vcomments"></div>
      <script>
        new Valine({
          el: '#vcomments',
          appId: '5bHFwYPW2iHWCiV7WmNRSenk-gzGzoHsz',
          appKey: '2q4UgVDTmeJf9Phe8VbnNKyC',
          avatar: 'monsterid',
          enableQQ: true
        })
      </script>
    </div>
   
</div>

  </div>
</div>
 
<div>
  <div
    id="sprite-container"
    data-mouse-out-ani='/2top/out_1.png'
    data-mouse-hover-ani='/2top/hover_1.png,/2top/hover_2.png'
    data-mouse-click-ani='/2top/click_1.png,/2top/click_2.png,/2top/click_3.png'
    >
    <canvas id="sprite-canvas" width="100" height="100"></canvas>
  </div>
</div>
    </div>
  </div>
</body>



    
<script src="/lib/jquery/jquery.min.js"></script>


    
<script src="/lib/jquery/jquery-ui.min.js"></script>


    
<script src="/lib/fancybox/jquery.fancybox.min.js"></script>


    
<script src="/lib/highlight/highlight.min.js"></script>


    
<script src="/js/milk.js"></script>



</html>
